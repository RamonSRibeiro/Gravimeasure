{% extends 'base.html' %}

{% block title %}Lista de Medi√ß√µes - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .filter-section {
        background: white;
        padding: 20px;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

    .filter-group label {
        font-weight: 700;
        color: var(--primary-blue);
        font-size: 0.85rem;
        margin-bottom: 5px;
    }

    .filter-group input,
    .filter-group select {
        padding: 8px 10px;
        border: 1px solid var(--border-gray);
        border-radius: 4px;
        font-size: 0.9rem;
    }

    /* Bulk Delete */
    .bulk-actions {
        margin-bottom: 15px;
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .bulk-actions button {
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 700;
    }

    .btn-select {
        background-color: #555;
        color: white;
    }

    .btn-delete {
        background-color: #c0392b;
        color: white;
    }

    @media (max-width: 768px) {
        .filter-row {
            grid-template-columns: 1fr;
        }
    }
    .pagination {
    display: flex;
    list-style: none;
    padding: 20px 0;
    justify-content: center;
}

.page-item {
    margin: 0 5px;
}

.page-link {
    padding: 8px 16px;
    border: 1px solid #dee2e6;
    text-decoration: none;
    color: #007bff;
    border-radius: 4px;
}

.page-item.active .page-link {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
}

.page-link:hover:not(.active) {
    background-color: #e9ecef;
}
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto; padding: 0 20px;">

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1 style="color: var(--primary-blue); margin: 0;">Medi√ß√µes Gravim√©tricas</h1>

        {% if user.is_operator or user.is_admin %}
        <div style="display: flex; gap: 10px;">
            <a href="{% url 'medicoes:importar_excel' %}"
               style="padding: 10px 20px; background-color: #28a745; color: white; text-decoration: none; border-radius: 4px; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.2rem;">üìä</span> Importar Excel
            </a>

            <a href="{% url 'medicoes:medicao_adicionar' %}"
               style="padding: 10px 20px; background-color: var(--primary-blue); color: white; text-decoration: none; border-radius: 4px;">
                + Adicionar Medi√ß√£o
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Filtros -->
    <div class="filter-section">
        <form method="get" id="filterForm">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Buscar</label>
                    <input type="text" name="search" value="{{ request.GET.search }}" placeholder="Nome, c√≥digo ou operador..." />
                </div>

                <div class="filter-group">
                    <label>Data Inicial</label>
                    <input type="date" name="data_inicio" value="{{ request.GET.data_inicio }}" />
                </div>

                <div class="filter-group">
                    <label>Data Final</label>
                    <input type="date" name="data_fim" value="{{ request.GET.data_fim }}" />
                </div>
            </div>

            <div class="filter-row">
                <div class="filter-group">
                    <label>Operador</label>
                    <input type="text" name="operador" value="{{ request.GET.operador }}" placeholder="Nome do operador..." />
                </div>

                <div class="filter-group">
                    <label>Gravidade M√≠nima (mGal)</label>
                    <input type="number" step="0.001" name="gravidade_min" value="{{ request.GET.gravidade_min }}" />
                </div>

                <div class="filter-group">
                    <label>Gravidade M√°xima (mGal)</label>
                    <input type="number" step="0.001" name="gravidade_max" value="{{ request.GET.gravidade_max }}" />
                </div>
            </div>

            <div style="display: flex; gap: 10px;">
                <button type="submit"
                        style="padding: 10px 20px; background-color: var(--primary-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 700;">
                    üîç Filtrar
                </button>

                {% if request.GET.search or request.GET.data_inicio or request.GET.data_fim or request.GET.operador or request.GET.gravidade_min or request.GET.gravidade_max %}
                <a href="{% url 'medicoes:medicao_lista' %}"
                   style="padding: 10px 20px; background-color: #666; color: white; text-decoration: none; border-radius: 4px; font-weight: 700;">
                    ‚úï Limpar Filtros
                </a>
                {% endif %}
            </div>
        </form>
    </div>

    <div style="background: white; padding: 20px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">

        {% if medicoes %}

        <!-- ‚úÖ Bulk Actions (somente admin) -->
        {% if user.is_admin %}
        <form id="bulkDeleteForm">
            {% csrf_token %}

            <div class="bulk-actions">
                <button type="button" class="btn-select" onclick="selecionarTodas()">
                    ‚úî Selecionar Todas
                </button>

                <button type="button" class="btn-delete" onclick="apagarSelecionadas()">
                    üóë Apagar Selecionadas
                </button>
            </div>
        </form>
        {% endif %}

        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        {% if user.is_admin %}
                        <th></th>
                        {% endif %}
                        <th>C√≥digo</th>
                        <th>Nome da Esta√ß√£o</th>
                        <th>Localiza√ß√£o</th>
                        <th>Gravidade (mGal)</th>
                        <th>Anomalia Bouguer (mGal)</th>
                        <th>Data</th>
                        <th style="text-align: center;">A√ß√µes</th>
                    </tr>
                </thead>

                <tbody>
                    {% for medicao in medicoes %}
                    <tr>
                        {% if user.is_admin %}
                        <td>
                            <input type="checkbox" name="ids" value="{{ medicao.id }}">
                        </td>
                        {% endif %}

                        <td><strong>{{ medicao.codigo_estacao }}</strong></td>

                        <td>
                            <a href="{% url 'medicoes:medicao_detail' medicao.codigo_estacao %}"
                               style="color: var(--primary-blue); text-decoration: none; font-weight: 600;">
                                {{ medicao.nome_estacao }}
                            </a>
                        </td>

                        <td style="font-size: 0.9rem;">
                            {{ medicao.latitude|floatformat:4 }}¬∞, {{ medicao.longitude|floatformat:4 }}¬∞
                            {% if medicao.altitude %}
                                <br><span style="color: #666;">Alt: {{ medicao.altitude }}m</span>
                            {% endif %}
                        </td>

                        <td>{{ medicao.valor_gravidade }}</td>

                        <td>
                            {% if medicao.anomalia_bouguer %}
                                <strong style="color: var(--primary-blue);">{{ medicao.anomalia_bouguer }}</strong>
                            {% else %}
                                <span style="color: #999;">-</span>
                            {% endif %}
                        </td>

                        <td>{{ medicao.data_medicao|date:"d/m/Y" }}</td>

                        <td style="text-align: center; font-size: 1.1rem;">
                            <a href="{% url 'medicoes:medicao_pdf' medicao.pk %}" title="PDF">üìÑ</a>

                            {% if user.is_operator or user.is_admin %}
                            <a href="{% url 'medicoes:medicao_editar' medicao.pk %}" title="Editar">‚úèÔ∏è</a>
                            {% endif %}

                            {% if user.is_admin %}
                            <a href="{% url 'medicoes:medicao_excluir' medicao.pk %}" title="Excluir">üóëÔ∏è</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>

            </table>
        </div>

        {% else %}
        <div style="text-align: center; padding: 40px; color: #666;">
            <p style="font-size: 1.2rem;">Nenhuma medi√ß√£o encontrada.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
function selecionarTodas() {
    document.querySelectorAll("input[name='ids']")
        .forEach(cb => cb.checked = true);
}

function apagarSelecionadas() {

    let selecionadas = [];
    document.querySelectorAll("input[name='ids']:checked")
        .forEach(cb => selecionadas.push(cb.value));

    if (selecionadas.length === 0) {
        alert("Nenhuma esta√ß√£o selecionada.");
        return;
    }

    if (!confirm("Tem certeza que deseja apagar as medi√ß√µes selecionadas?")) {
        return;
    }

    fetch("{% url 'medicoes:bulk_delete' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: selecionadas.map(id => "ids[]=" + id).join("&")
    })
    .then(resp => resp.json())
    .then(data => {
        alert(data.message);
        location.reload();
    })
    .catch(err => alert("Erro ao apagar: " + err));
}
</script>
<div class="pagination-container">
    <nav aria-label="Navega√ß√£o de medi√ß√µes">
        <ul class="pagination">

            {# Link para a Primeira P√°gina #}
            {% if page_obj.number > 1 %}
                <li class="page-item">
                    <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">&laquo; Primeira</a>
                </li>
            {% endif %}

            {# Exibi√ß√£o das p√°ginas numeradas (1, 2, 3...) #}
            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                    </li>
                {% endif %}
            {% endfor %}

            {# Link para a √öltima P√°gina #}
            {% if page_obj.number < page_obj.paginator.num_pages %}
                {% if page_obj.number < page_obj.paginator.num_pages|add:'-2' %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                        √öltima ({{ page_obj.paginator.num_pages }}) &raquo;
                    </a>
                </li>
            {% endif %}

        </ul>
    </nav>
</div>

{% endblock %}
